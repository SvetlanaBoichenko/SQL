Оператор WITH создаёт временное табличное выражение к которому можно обращаться в последующих запросах. 
1.Создается временная таблица expedition_stats (статистика экспедиции)
В которой подсчитывается:
а) общее число гномов в экспедиции
b) число выживших гномов, путем суммирования значений 1 с помощью выражения:
CASE WHEN em.survived = TRUE THEN 1 ELSE 0 END (если true , то прибавить 1, иначе 0)
с) Подсчет стоимости артефактов с использованием функции COALESCE – если артефакта нет, в сумму добавляем 0.
d) Подсчет обнаруженных мест, исключая повторяющиеся с помощью DISTINCT
e) Аналогично п. b  подсчет удачных исходов при столкновении с чужаками
f) Подсчет количества чужаков
j) Добавление в таблицу дату начала и окончания экспедиции.
Далее для формирования таблицы используется left join для таблиц:
- expedition_members
- expedition_artifacts
- expedition_sites
- expedition_creatures
Со связкой по внешнему полю expedition_id и группировкой по полям:
expedition_id, destination, status, departure_date, return_date из таблицы expeditions.

2. Создается временная таблица skills_progression
Во второй таблице:
- подсчитывается накопление разницы уровней skill до и после экспедиции 
- добавляются столбцы из таблиц dwarves, dwarf_skills с разными именами (ds_before
 и ds_after), expeditions e
Прогресс про skills производится выборке ds_before и ds_after по датам. Те поля, что датированы до departure_date - ds_before, те что после return_date - ds_after. (Я не догадалась☹).
3. Формирование итоговой таблицы с использованием данных из двух предыдущих.
- Первые 5 полей – берем из временной таблицы 1 expedition_stats. Поле surviving_members уже вычислено.
-Вычисление процента выживших гномов с точность до двух цифр.
- Поля из временной таблицы 1 которые уже вычислены – число артефактов и обнаруженных мест
- Вычисление процента удачных встреч с чужаками, с использованием функций NULLIF (возвращает NULL, если выражение равны)для защиты от деления на 0  основываясь на данных поля таблицы 1 total_encounters
-Вычисление skill_improvement с использованием поля временной таблицы 2 total_skill_improvement
- Вычисление длительности экспедиции, с использованием функции Extract( DAY FROM, которая извлекает день месяца из даты  
Вычисление поля overall_success_score (общий успех ) сумм долей каждой составляющей  части успеха – процент выживших , стоимость артефактов, количество новых мест, процент успешных столкновений, процент гномов, улучивших свои навыки, представленная как 1 в случае 100 процентного успеха.

В моем решении ошибки в формировании JSON_ARRAYAGG, которые я не должна была допускать, 
Select JSON_ARRAYAGG (ea2.artifact_id)
   From EXPEDITION_ARTIFACTS ea2, EXPEDITION ex9
  where ea2.expedition_id = ex9.expedition_id
EXPEDITION ex9 – лишняя операция, 
надо было:
where ea2.expedition_id = exр.expedition_id – таблица, обьявленная в начале запроса.

В общем и целом. – конечно не справилась с заданием. Но, я хотя бы попыталась.
Спасибо за урок.
